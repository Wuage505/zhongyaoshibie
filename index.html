<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>中药识别</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation;
        }
        .media-container {
            position: relative;
            width: 100%;
            padding-top: 133%;
            overflow: hidden;
            border-radius: 16px;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #webcam, #uploaded-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #uploaded-image {
            display: none;
        }
        .btn {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .result-card {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            display: none;
        }
        .result-card.show {
            transform: translateY(0);
            opacity: 1;
            display: block;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #image-upload {
            display: none;
        }
        .loading-mask {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }
        .prob-item {
            transition: all 0.2s ease;
        }
        .prob-item.highlight {
            transform: scale(1.03);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #f0f9ff;
        }
        .mobile-btn {
            min-height: 56px;
            min-width: 56px;
            font-size: 16px;
        }
        .model-progress {
            height: 2px;
            background: #e5e7eb;
            width: 100%;
            margin: 10px 0;
            border-radius: 1px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #16a34a;
            width: 0%;
            transition: width 0.3s ease;
        }
        .offline-alert {
            background: #fef2f2;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }
        .wiki-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 12px;
            background-color: #3b82f6;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .wiki-btn:hover {
            background-color: #2563eb;
        }
        /* 摄像头切换提示 */
        .cam-tip {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 4px;
            display: none;
        }
        /* 配伍样式 */
        .compatibility-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d1d5db;
        }
        .compatibility-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
        }
        .compatibility-item {
            font-size: 12px;
            margin-bottom: 3px;
            line-height: 1.4;
        }
        .compatibility-item i {
            font-size: 11px;
            margin-right: 4px;
            color: #059669;
        }
        /* 典籍链接样式 */
        .classics-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d1d5db;
        }
        .classics-title {
            font-size: 13px;
            font-weight: 600;
            color: #7e22ce;
            margin-bottom: 6px;
        }
        .classic-btn {
            display: inline-block;
            margin: 0 4px 6px 0;
            padding: 3px 10px;
            background-color: #8b5cf6;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .classic-btn:hover {
            background-color: #7c3aed;
            transform: translateY(-1px);
        }
        .classic-btn i {
            font-size: 10px;
            margin-right: 3px;
        }
        /* 来源标注 */
        .source-note {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 6px;
            text-align: right;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1f2937;
                color: #fff;
            }
            .media-container {
                background-color: #111827;
            }
            .result-card {
                background-color: #374151;
                color: #fff;
            }
            .prob-item {
                background-color: #4b5563;
                color: #fff;
            }
            .prob-item.highlight {
                background-color: #1e3a8a;
            }
            .herb-tips {
                background-color: #4b5563;
                color: #e5e7eb;
            }
            #reset-btn {
                background-color: #5865f2;
                color: #fff;
            }
            .wiki-btn {
                background-color: #2563eb;
            }
            .wiki-btn:hover {
                background-color: #1d4ed8;
            }
            .cam-tip {
                color: #9ca3af;
            }
            .compatibility-section {
                border-top: 1px dashed #4b5563;
            }
            .classics-section {
                border-top: 1px dashed #4b5563;
            }
            .compatibility-title {
                color: #f59e0b;
            }
            .classics-title {
                color: #a855f7;
            }
            .source-note {
                color: #6b7280;
            }
        }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <div id="offline-alert" class="offline-alert">
        <<i class="fa fa-wifi-slash mr-1"></</i> 检测到离线状态，模型加载失败
    </div>

    <div class="text-center mb-6">
        <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-green-700 dark:text-green-400">
            <<i class="fa fa-leaf mr-2"></</i>中药识别
        </h1>
        <p class="text-gray-500 dark:text-gray-300 text-sm">支持拍照或上传图片识别：枸杞、菊花、人参、甘草、金银花</p>
        <div class="model-progress mx-auto max-w-xs">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </div>

    <div class="media-container mb-6 relative">
        <video id="webcam" autoplay muted playsinline style="display: none;"></video>
        <img id="uploaded-image" alt="上传的图片">
        <div id="media-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-white">
            <<i class="fa fa-camera text-5xl mb-3 opacity-70"></</i>
            <p class="text-sm opacity-70">点击下方按钮选择识别方式</p>
        </div>
        <div id="loading-mask" class="loading-mask hidden">
            <div class="flex flex-col items-center text-white">
                <<i class="fa fa-circle-o-notch loading-spinner text-4xl mb-2"></</i>
                <p class="text-sm">识别中，请稍候...</p>
            </div>
        </div>
    </div>

    <div class="flex flex-wrap justify-center gap-3 mb-6">
        <button id="start-cam-btn" class="btn mobile-btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-blue-600 dark:hover:bg-blue-700">
            <<i class="fa fa-video-camera mr-2"></</i> 相机识别
        </button>
        <button id="flip-cam-btn" class="btn mobile-btn bg-gray-500 hover:bg-gray-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-gray-700 dark:hover:bg-gray-600">
            <<i class="fa fa-exchange mr-2"></</i> 反转镜头
        </button>
        <!-- 摄像头切换提示 -->
        <div id="cam-tip" class="cam-tip col-span-full">部分手机需授权后才能切换摄像头</div>
        <label for="image-upload" class="btn mobile-btn bg-purple-500 hover:bg-purple-600 text-white px-5 py-3 rounded-full flex items-center shadow-md cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-purple-600 dark:hover:bg-purple-700">
            <<i class="fa fa-upload mr-2"></</i> 上传图片
        </label>
        <input type="file" id="image-upload" accept="image/*">
        <button id="identify-btn" class="btn mobile-btn bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-green-600 dark:hover:bg-green-700">
            <<i class="fa fa-search mr-2"></</i> 开始识别
        </button>
    </div>

    <div id="result-card" class="result-card bg-white rounded-xl shadow-md p-5 mb-6 dark:bg-gray-800">
        <h2 class="text-xl font-semibold text-center mb-4 dark:text-white">识别结果</h2>
        <div class="text-center mb-4">
            <p id="prediction" class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-purple-600 dark:text-purple-400">--</p>
            <p id="confidence" class="text-gray-500 dark:text-gray-300">可信度：--%</p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="枸杞">
                <p class="text-sm text-gray-500 dark:text-gray-300">枸杞</p>
                <p id="wolfberry" class="font-bold text-red-500 dark:text-red-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="菊花">
                <p class="text-sm text-gray-500 dark:text-gray-300">菊花</p>
                <p id="chrysanthemum" class="font-bold text-yellow-500 dark:text-yellow-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="人参">
                <p class="text-sm text-gray-500 dark:text-gray-300">人参</p>
                <p id="ginseng" class="font-bold text-orange-500 dark:text-orange-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="甘草">
                <p class="text-sm text-gray-500 dark:text-gray-300">甘草</p>
                <p id="liquorice" class="font-bold text-blue-500 dark:text-blue-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg col-span-2 dark:bg-gray-700" data-herb="金银花">
                <p class="text-sm text-gray-500 dark:text-gray-300">金银花</p>
                <p id="honeysuckle" class="font-bold text-green-500 dark:text-green-400">--%</p>
            </div>
        </div>
        <div id="herb-tips" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 dark:bg-gray-700 dark:text-gray-200">
            <p><<i class="fa fa-info-circle mr-1 text-blue-500 dark:text-blue-400"></</i> 识别结果后将显示对应药材的简要介绍</p>
            <a id="wiki-btn" href="#" class="wiki-btn hidden" target="_blank">
                <<i class="fa fa-external-link mr-1"></</i> 查看百度百科
            </a>
        </div>
        <button id="reset-btn" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg btn mobile-btn dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500">
            <<i class="fa fa-refresh mr-1"></</i> 重新识别
        </button>
    </div>

    <div id="status" class="text-center text-gray-500 dark:text-gray-300 text-sm py-2">
        <<i class="fa fa-circle-o-notch fa-spin mr-1 loading-spinner"></</i> 加载模型中...
    </div>

    <script>
        const herbKnowledge = {
            枸杞: "枸杞：滋补肝肾，益精明目。用于虚劳
