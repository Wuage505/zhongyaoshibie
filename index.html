<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>ä¸­è¯è¯†åˆ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation;
        }
        .media-container {
            position: relative;
            width: 100%;
            padding-top: 133%;
            overflow: hidden;
            border-radius: 16px;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #webcam, #uploaded-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #uploaded-image {
            display: none;
        }
        .btn {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .result-card {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            display: none;
        }
        .result-card.show {
            transform: translateY(0);
            opacity: 1;
            display: block;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #image-upload {
            display: none;
        }
        .loading-mask {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }
        .prob-item {
            transition: all 0.2s ease;
        }
        .prob-item.highlight {
            transform: scale(1.03);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #f0f9ff;
        }
        .mobile-btn {
            min-height: 56px;
            min-width: 56px;
            font-size: 16px;
        }
        .model-progress {
            height: 2px;
            background: #e5e7eb;
            width: 100%;
            margin: 10px 0;
            border-radius: 1px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #16a34a;
            width: 0%;
            transition: width 0.3s ease;
        }
        .offline-alert {
            background: #fef2f2;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }
        .wiki-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 12px;
            background-color: #3b82f6;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .wiki-btn:hover {
            background-color: #2563eb;
        }
        /* æ‘„åƒå¤´åˆ‡æ¢æç¤º */
        .cam-tip {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 4px;
            display: none;
        }
        /* é…ä¼æ ·å¼ */
        .compatibility-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d1d5db;
        }
        .compatibility-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
        }
        .compatibility-item {
            font-size: 12px;
            margin-bottom: 3px;
            line-height: 1.4;
        }
        .compatibility-item i {
            font-size: 11px;
            margin-right: 4px;
            color: #059669;
        }
        /* å…¸ç±é“¾æ¥æ ·å¼ */
        .classics-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d1d5db;
        }
        .classics-title {
            font-size: 13px;
            font-weight: 600;
            color: #7e22ce;
            margin-bottom: 6px;
        }
        .classic-btn {
            display: inline-block;
            margin: 0 4px 6px 0;
            padding: 3px 10px;
            background-color: #8b5cf6;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .classic-btn:hover {
            background-color: #7c3aed;
            transform: translateY(-1px);
        }
        .classic-btn i {
            font-size: 10px;
            margin-right: 3px;
        }
        /* æ¥æºæ ‡æ³¨ */
        .source-note {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 6px;
            text-align: right;
        }
        /* æš—é»‘æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1f2937;
                color: #fff;
            }
            .media-container {
                background-color: #111827;
            }
            .result-card {
                background-color: #374151;
                color: #fff;
            }
            .prob-item {
                background-color: #4b5563;
                color: #fff;
            }
            .prob-item.highlight {
                background-color: #1e3a8a;
            }
            .herb-tips {
                background-color: #4b5563;
                color: #e5e7eb;
            }
            #reset-btn {
                background-color: #5865f2;
                color: #fff;
            }
            .wiki-btn {
                background-color: #2563eb;
            }
            .wiki-btn:hover {
                background-color: #1d4ed8;
            }
            .cam-tip {
                color: #9ca3af;
            }
            .compatibility-section {
                border-top: 1px dashed #4b5563;
            }
            .classics-section {
                border-top: 1px dashed #4b5563;
            }
            .compatibility-title {
                color: #f59e0b;
            }
            .classics-title {
                color: #a855f7;
            }
            .source-note {
                color: #6b7280;
            }
        }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <!-- ç¦»çº¿æç¤º -->
    <div id="offline-alert" class="offline-alert">
        <i class="fa fa-wifi-slash mr-1"></i> æ£€æµ‹åˆ°ç¦»çº¿çŠ¶æ€ï¼Œæ¨¡å‹åŠ è½½å¤±è´¥
    </div>

    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="text-center mb-6">
        <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-green-700 dark:text-green-400">
            <i class="fa fa-leaf mr-2"></i>ä¸­è¯è¯†åˆ«
        </h1>
        <p class="text-gray-500 dark:text-gray-300 text-sm">æ”¯æŒæ‹ç…§æˆ–ä¸Šä¼ å›¾ç‰‡è¯†åˆ«ï¼šæ¸æã€èŠèŠ±ã€äººå‚ã€ç”˜è‰ã€é‡‘é“¶èŠ±</p>
        <div class="model-progress mx-auto max-w-xs">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´/å›¾ç‰‡å®¹å™¨ -->
    <div class="media-container mb-6 relative">
        <video id="webcam" autoplay muted playsinline style="display: none;"></video>
        <img id="uploaded-image" alt="ä¸Šä¼ çš„å›¾ç‰‡">
        <div id="media-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-white">
            <i class="fa fa-camera text-5xl mb-3 opacity-70"></i>
            <p class="text-sm opacity-70">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©è¯†åˆ«æ–¹å¼</p>
        </div>
        <div id="loading-mask" class="loading-mask hidden">
            <div class="flex flex-col items-center text-white">
                <i class="fa fa-circle-o-notch loading-spinner text-4xl mb-2"></i>
                <p class="text-sm">è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <div class="flex flex-wrap justify-center gap-3 mb-6">
        <button id="start-cam-btn" class="btn mobile-btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-blue-600 dark:hover:bg-blue-700">
            <i class="fa fa-video-camera mr-2"></i> ç›¸æœºè¯†åˆ«
        </button>
        <button id="flip-cam-btn" class="btn mobile-btn bg-gray-500 hover:bg-gray-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-gray-700 dark:hover:bg-gray-600">
            <i class="fa fa-exchange mr-2"></i> åè½¬é•œå¤´
        </button>
        <!-- æ‘„åƒå¤´åˆ‡æ¢æç¤º -->
        <div id="cam-tip" class="cam-tip col-span-full">éƒ¨åˆ†æ‰‹æœºéœ€æˆæƒåæ‰èƒ½åˆ‡æ¢æ‘„åƒå¤´</div>
        <label for="image-upload" class="btn mobile-btn bg-purple-500 hover:bg-purple-600 text-white px-5 py-3 rounded-full flex items-center shadow-md cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-purple-600 dark:hover:bg-purple-700">
            <i class="fa fa-upload mr-2"></i> ä¸Šä¼ å›¾ç‰‡
        </label>
        <input type="file" id="image-upload" accept="image/*">
        <button id="identify-btn" class="btn mobile-btn bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-full flex items-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed dark:bg-green-600 dark:hover:bg-green-700">
            <i class="fa fa-search mr-2"></i> å¼€å§‹è¯†åˆ«
        </button>
    </div>

    <!-- è¯†åˆ«ç»“æœå¡ç‰‡ -->
    <div id="result-card" class="result-card bg-white rounded-xl shadow-md p-5 mb-6 dark:bg-gray-800">
        <h2 class="text-xl font-semibold text-center mb-4 dark:text-white">è¯†åˆ«ç»“æœ</h2>
        <div class="text-center mb-4">
            <p id="prediction" class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-purple-600 dark:text-purple-400">--</p>
            <p id="confidence" class="text-gray-500 dark:text-gray-300">å¯ä¿¡åº¦ï¼š--%</p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="æ¸æ">
                <p class="text-sm text-gray-500 dark:text-gray-300">æ¸æ</p>
                <p id="wolfberry" class="font-bold text-red-500 dark:text-red-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="èŠèŠ±">
                <p class="text-sm text-gray-500 dark:text-gray-300">èŠèŠ±</p>
                <p id="chrysanthemum" class="font-bold text-yellow-500 dark:text-yellow-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="äººå‚">
                <p class="text-sm text-gray-500 dark:text-gray-300">äººå‚</p>
                <p id="ginseng" class="font-bold text-orange-500 dark:text-orange-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg dark:bg-gray-700" data-herb="ç”˜è‰">
                <p class="text-sm text-gray-500 dark:text-gray-300">ç”˜è‰</p>
                <p id="liquorice" class="font-bold text-blue-500 dark:text-blue-400">--%</p>
            </div>
            <div class="prob-item bg-gray-50 p-3 rounded-lg col-span-2 dark:bg-gray-700" data-herb="é‡‘é“¶èŠ±">
                <p class="text-sm text-gray-500 dark:text-gray-300">é‡‘é“¶èŠ±</p>
                <p id="honeysuckle" class="font-bold text-green-500 dark:text-green-400">--%</p>
            </div>
        </div>
        <div id="herb-tips" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 dark:bg-gray-700 dark:text-gray-200">
            <p><i class="fa fa-info-circle mr-1 text-blue-500 dark:text-blue-400"></i> è¯†åˆ«ç»“æœåå°†æ˜¾ç¤ºå¯¹åº”è¯æçš„ç®€è¦ä»‹ç»</p>
            <a id="wiki-btn" href="#" class="wiki-btn hidden" target="_blank">
                <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹ç™¾åº¦ç™¾ç§‘
            </a>
        </div>
        <button id="reset-btn" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg btn mobile-btn dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500">
            <i class="fa fa-refresh mr-1"></i> é‡æ–°è¯†åˆ«
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div id="status" class="text-center text-gray-500 dark:text-gray-300 text-sm py-2">
        <i class="fa fa-circle-o-notch fa-spin mr-1 loading-spinner"></i> åŠ è½½æ¨¡å‹ä¸­...
    </div>

    <script>
        // è¯æçŸ¥è¯†åº“ï¼ˆå«å…¸ç±è·³è½¬é“¾æ¥ï¼‰
        const herbKnowledge = {
            æ¸æ: {
                desc: "æ¸æï¼šæ»‹è¡¥è‚è‚¾ï¼Œç›Šç²¾æ˜ç›®ã€‚ç”¨äºè™šåŠ³ç²¾äºï¼Œè…°è†é…¸ç—›ï¼Œçœ©æ™•è€³é¸£ï¼Œé˜³ç—¿é—ç²¾ï¼Œå†…çƒ­æ¶ˆæ¸´ï¼Œè¡€è™šèé»„ï¼Œç›®æ˜ä¸æ˜ã€‚",
                compatibility: [
                    "é…èŠèŠ±ï¼šæ¸…è‚æ˜ç›®ï¼Œé€‚ç”¨äºè‚è‚¾é˜´è™šä¹‹ç›®æ˜çœ¼èŠ±",
                    "é…ç†Ÿåœ°ï¼šæ»‹é˜´è¡¥è‚¾ï¼Œé€‚ç”¨äºè‚¾é˜´ä¸è¶³ä¹‹è…°è†é…¸è½¯",
                    "é…é»„èŠªï¼šè¡¥æ°”å…»é˜´ï¼Œé€‚ç”¨äºæ°”è™šé˜´äºä¹‹ä¹åŠ›å£å¹²"
                ],
                classics: {
                    "ã€Šæœ¬è‰çº²ç›®ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaogangmu/index.html",
                    "ã€Šç¥å†œæœ¬è‰ç»ã€‹": "http://www.dazhongyi.cc/lilunshuji/shennongbencaojing/index.html",
                    "ã€Šä¼¤å¯’æ‚ç—…è®ºã€‹": "http://www.dazhongyi.cc/lilunshuji/shanghanzabinglun/index.html"
                },
                wiki: "https://baike.baidu.com/item/%E6%9E%B8%E6%9D%9E/3367"
            },
            èŠèŠ±: {
                desc: "èŠèŠ±ï¼šæ•£é£æ¸…çƒ­ï¼Œå¹³è‚æ˜ç›®ï¼Œæ¸…çƒ­è§£æ¯’ã€‚ç”¨äºé£çƒ­æ„Ÿå†’ï¼Œå¤´ç—›çœ©æ™•ï¼Œç›®èµ¤è‚¿ç—›ï¼Œçœ¼ç›®æ˜èŠ±ï¼Œç–®ç—ˆè‚¿æ¯’ã€‚",
                compatibility: [
                    "é…æ¸æï¼šæ»‹è¡¥è‚è‚¾ï¼Œæ¸…è‚æ˜ç›®",
                    "é…æ¡‘å¶ï¼šç–é£æ¸…çƒ­ï¼Œé€‚ç”¨äºé£çƒ­æ„Ÿå†’ä¹‹å¤´ç—›ç›®èµ¤",
                    "é…å†³æ˜å­ï¼šæ¸…è‚æ˜ç›®ï¼Œé€‚ç”¨äºè‚ç«ä¸Šç‚ä¹‹ç›®èµ¤è‚¿ç—›"
                ],
                classics: {
                    "ã€Šæœ¬è‰çº²ç›®ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaogangmu/index.html",
                    "ã€Šç¥å†œæœ¬è‰ç»ã€‹": "http://www.dazhongyi.cc/lilunshuji/shennongbencaojing/index.html",
                    "ã€Šåƒé‡‘æ–¹ã€‹": "http://www.dazhongyi.cc/lilunshuji/qianjinfang/index.html"
                },
                wiki: "https://baike.baidu.com/item/%E8%8F%8A%E8%8A%B1/3359"
            },
            äººå‚: {
                desc: "äººå‚ï¼šå¤§è¡¥å…ƒæ°”ï¼Œå¤è„‰å›ºè„±ï¼Œç›Šæ°”æ‘„è¡€ã€‚ç”¨äºä½“è™šæ¬²è„±ï¼Œè‚¢å†·è„‰å¾®ï¼Œæ°”ä¸æ‘„è¡€ï¼Œå´©æ¼ä¸‹è¡€ï¼›å¿ƒåŠ›è¡°ç«­ï¼Œå¿ƒåŸæ€§ä¼‘å…‹ã€‚",
                compatibility: [
                    "é…é»„èŠªï¼šè¡¥æ°”å‡é˜³ï¼Œé€‚ç”¨äºæ°”è™šä¹åŠ›",
                    "é…å½“å½’ï¼šæ°”è¡€åŒè¡¥ï¼Œé€‚ç”¨äºæ°”è¡€ä¸¤è™š",
                    "é…éº¦å†¬ï¼šç›Šæ°”å…»é˜´ï¼Œé€‚ç”¨äºæ°”é˜´ä¸¤è™š"
                ],
                classics: {
                    "ã€Šæœ¬è‰çº²ç›®ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaogangmu/index.html",
                    "ã€Šç¥å†œæœ¬è‰ç»ã€‹": "http://www.dazhongyi.cc/lilunshuji/shennongbencaojing/index.html",
                    "ã€Šæœ¬è‰ç»é›†æ³¨ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaojingjizhu/index.html"
                },
                wiki: "https://baike.baidu.com/item/%E4%BA%BA%E5%8F%82/3344"
            },
            ç”˜è‰: {
                desc: "ç”˜è‰ï¼šè¡¥è„¾ç›Šæ°”ï¼Œæ¸…çƒ­è§£æ¯’ï¼Œç¥›ç—°æ­¢å’³ï¼Œç¼“æ€¥æ­¢ç—›ï¼Œè°ƒå’Œè¯¸è¯ã€‚ç”¨äºè„¾èƒƒè™šå¼±ï¼Œå€¦æ€ ä¹åŠ›ï¼Œå¿ƒæ‚¸æ°”çŸ­ï¼Œå’³å—½ç—°å¤šã€‚",
                compatibility: [
                    "é…æ¡‚æï¼šæ¸©ä¸­ç›Šæ°”ï¼Œé€‚ç”¨äºè„¾èƒƒè™šå¯’",
                    "é…æ¡”æ¢—ï¼šåˆ©å’½åŒ–ç—°ï¼Œé€‚ç”¨äºå’½å–‰è‚¿ç—›",
                    "é…ç™½èŠï¼šç¼“æ€¥æ­¢ç—›ï¼Œé€‚ç”¨äºè„˜è…¹æŒ›ç—›"
                ],
                classics: {
                    "ã€Šæœ¬è‰çº²ç›®ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaogangmu/index.html",
                    "ã€Šç¥å†œæœ¬è‰ç»ã€‹": "http://www.dazhongyi.cc/lilunshuji/shennongbencaojing/index.html",
                    "ã€Šä¼¤å¯’æ‚ç—…è®ºã€‹": "http://www.dazhongyi.cc/lilunshuji/shanghanzabinglun/index.html"
                },
                wiki: "https://baike.baidu.com/item/%E7%94%98%E8%8D%89/3392"
            },
            é‡‘é“¶èŠ±: {
                desc: "é‡‘é“¶èŠ±ï¼šæ¸…çƒ­è§£æ¯’ï¼Œç–æ•£é£çƒ­ã€‚ç”¨äºç—ˆè‚¿ç–”ç–®ï¼Œå–‰ç—¹ï¼Œä¸¹æ¯’ï¼Œçƒ­æ¯’è¡€ç—¢ï¼Œé£çƒ­æ„Ÿå†’ï¼Œæ¸©ç—…å‘çƒ­ã€‚",
                compatibility: [
                    "é…è¿ç¿˜ï¼šæ¸…çƒ­è§£æ¯’ï¼Œé€‚ç”¨äºé£çƒ­æ„Ÿå†’",
                    "é…è’²å…¬è‹±ï¼šæ¸…çƒ­è§£æ¯’ï¼Œé€‚ç”¨äºç–®ç—ˆè‚¿æ¯’",
                    "é…è–„è·ï¼šç–æ•£é£çƒ­ï¼Œé€‚ç”¨äºé£çƒ­æ„Ÿå†’ä¹‹å‘çƒ­å’½ç—›"
                ],
                classics: {
                    "ã€Šæœ¬è‰çº²ç›®ã€‹": "http://www.dazhongyi.cc/lilunshuji/bencaogangmu/index.html",
                    "ã€Šç¥å†œæœ¬è‰ç»ã€‹": "http://www.dazhongyi.cc/lilunshuji/shennongbencaojing/index.html",
                    "ã€Šæ¸©ç—…æ¡è¾¨ã€‹": "http://www.dazhongyi.cc/lilunshuji/wenbingtiaobian/index.html"
                },
                wiki: "https://baike.baidu.com/item/%E9%87%91%E9%93%B6%E8%8A%B1/3398"
            }
        };

        // DOMå…ƒç´ 
        const webcam = document.getElementById('webcam');
        const uploadedImage = document.getElementById('uploaded-image');
        const mediaPlaceholder = document.getElementById('media-placeholder');
        const startCamBtn = document.getElementById('start-cam-btn');
        const flipCamBtn = document.getElementById('flip-cam-btn');
        const imageUpload = document.getElementById('image-upload');
        const identifyBtn = document.getElementById('identify-btn');
        const resetBtn = document.getElementById('reset-btn');
        const loadingMask = document.getElementById('loading-mask');
        const resultCard = document.getElementById('result-card');
        const prediction = document.getElementById('prediction');
        const confidence = document.getElementById('confidence');
        const herbTips = document.getElementById('herb-tips');
        const wikiBtn = document.getElementById('wiki-btn');
        const statusText = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const offlineAlert = document.getElementById('offline-alert');
        const camTip = document.getElementById('cam-tip');
        
        // æ¦‚ç‡é¡¹å…ƒç´ 
        const wolfberryEl = document.getElementById('wolfberry');
        const chrysanthemumEl = document.getElementById('chrysanthemum');
        const ginsengEl = document.getElementById('ginseng');
        const liquoriceEl = document.getElementById('liquorice');
        const honeysuckleEl = document.getElementById('honeysuckle');
        const probItems = document.querySelectorAll('.prob-item');

        // å…¨å±€å˜é‡
        let model;
        let stream;
        let currentCam = 'user'; // user: å‰ç½®, environment: åç½®
        let isModelLoaded = false;

        // æ£€æŸ¥ç¦»çº¿çŠ¶æ€
        if (!navigator.onLine) {
            offlineAlert.style.display = 'block';
        }

        // åŠ è½½TFJSæ¨¡å‹
        async function loadModel() {
            try {
                // æ¨¡æ‹Ÿè¿›åº¦æ¡
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress > 100) progress = 100;
                    progressBar.style.width = `${progress}%`;
                    if (progress === 100) clearInterval(progressInterval);
                }, 200);

                // è¿™é‡Œæ›¿æ¢ä¸ºå®é™…æ¨¡å‹åŠ è½½é€»è¾‘ï¼ˆç¤ºä¾‹ç”¨éšæœºæ¨¡æ‹Ÿï¼‰
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // æ ‡è®°æ¨¡å‹åŠ è½½å®Œæˆ
                isModelLoaded = true;
                progressBar.style.width = '100%';
                statusText.innerHTML = '<i class="fa fa-check text-green-500 mr-1"></i> æ¨¡å‹åŠ è½½å®Œæˆ';
                
                // å¯ç”¨æŒ‰é’®
                startCamBtn.disabled = false;
                imageUpload.disabled = false;
                flipCamBtn.disabled = false;
                
            } catch (error) {
                console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                statusText.innerHTML = '<i class="fa fa-exclamation-triangle text-red-500 mr-1"></i> æ¨¡å‹åŠ è½½å¤±è´¥';
                offlineAlert.style.display = 'block';
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                // åœæ­¢ç°æœ‰æµ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // æ‘„åƒå¤´çº¦æŸ
                const constraints = {
                    video: {
                        facingMode: currentCam,
                        width: { ideal: 400 },
                        height: { ideal: 500 }
                    }
                };

                // è·å–æ‘„åƒå¤´æµ
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                webcam.srcObject = stream;
                webcam.style.display = 'block';
                uploadedImage.style.display = 'none';
                mediaPlaceholder.style.display = 'none';
                
                // æ˜¾ç¤ºæ‘„åƒå¤´åˆ‡æ¢æç¤º
                camTip.style.display = 'block';
                
                // å¯ç”¨è¯†åˆ«æŒ‰é’®
                identifyBtn.disabled = !isModelLoaded;

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                statusText.innerHTML = '<i class="fa fa-exclamation-triangle text-red-500 mr-1"></i> æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æˆæƒ';
                camTip.style.display = 'block';
                camTip.textContent = 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´æƒé™';
            }
        }

        // åˆ‡æ¢æ‘„åƒå¤´
        async function flipCamera() {
            currentCam = currentCam === 'user' ? 'environment' : 'user';
            await startCamera();
            camTip.textContent = `å½“å‰ä½¿ç”¨${currentCam === 'user' ? 'å‰ç½®' : 'åç½®'}æ‘„åƒå¤´`;
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                uploadedImage.src = event.target.result;
                uploadedImage.style.display = 'block';
                webcam.style.display = 'none';
                mediaPlaceholder.style.display = 'none';
                
                // åœæ­¢æ‘„åƒå¤´
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // å¯ç”¨è¯†åˆ«æŒ‰é’®
                identifyBtn.disabled = !isModelLoaded;
                camTip.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // æ¨¡æ‹Ÿè¯†åˆ«é€»è¾‘
        async function identifyHerb() {
            if (!isModelLoaded) return;

            // æ˜¾ç¤ºåŠ è½½é®ç½©
            loadingMask.style.display = 'flex';
            identifyBtn.disabled = true;

            try {
                // æ¨¡æ‹Ÿè¯†åˆ«å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));

                // ç”Ÿæˆéšæœºæ¦‚ç‡
                const probabilities = {
                    æ¸æ: Math.random() * 100,
                    èŠèŠ±: Math.random() * 100,
                    äººå‚: Math.random() * 100,
                    ç”˜è‰: Math.random() * 100,
                    é‡‘é“¶èŠ±: Math.random() * 100
                };

                // æ‰¾å‡ºæœ€å¤§å€¼
                let maxProb = 0;
                let maxHerb = '';
                for (const [herb, prob] of Object.entries(probabilities)) {
                    if (prob > maxProb) {
                        maxProb = prob;
                        maxHerb = herb;
                    }
                }

                // æ›´æ–°æ¦‚ç‡æ˜¾ç¤º
                wolfberryEl.textContent = `${probabilities.æ¸æ.toFixed(1)}%`;
                chrysanthemumEl.textContent = `${probabilities.èŠèŠ±.toFixed(1)}%`;
                ginsengEl.textContent = `${probabilities.äººå‚.toFixed(1)}%`;
                liquoriceEl.textContent = `${probabilities.ç”˜è‰.toFixed(1)}%`;
                honeysuckleEl.textContent = `${probabilities.é‡‘é“¶èŠ±.toFixed(1)}%`;

                // é«˜äº®æœ€å¤§æ¦‚ç‡é¡¹
                probItems.forEach(item => {
                    item.classList.remove('highlight');
                    if (item.dataset.herb === maxHerb) {
                        item.classList.add('highlight');
                    }
                });

                // æ›´æ–°ç»“æœ
                prediction.textContent = maxHerb;
                confidence.textContent = `å¯ä¿¡åº¦ï¼š${maxProb.toFixed(1)}%`;

                // æ›´æ–°è¯ææç¤º
                const herbData = herbKnowledge[maxHerb];
                herbTips.innerHTML = `
                    <p><i class="fa fa-info-circle mr-1 text-blue-500 dark:text-blue-400"></i> ${herbData.desc}</p>
                    
                    <!-- é…ä¼ä¿¡æ¯ -->
                    <div class="compatibility-section">
                        <div class="compatibility-title">âœ¨ ç»å…¸é…ä¼</div>
                        ${herbData.compatibility.map(item => `
                            <div class="compatibility-item"><i class="fa fa-leaf"></i>${item}</div>
                        `).join('')}
                    </div>
                    
                    <!-- å…¸ç±é“¾æ¥ -->
                    <div class="classics-section">
                        <div class="classics-title">ğŸ“š å…¸ç±è®°è½½</div>
                        ${Object.entries(herbData.classics).map(([name, url]) => `
                            <a href="${url}" class="classic-btn" target="_blank"><i class="fa fa-book"></i>${name}</a>
                        `).join('')}
                        <div class="source-note">æ•°æ®æ¥æºï¼šå¤§ä¼—ä¸­åŒ»ç½‘</div>
                    </div>
                    
                    <a id="wiki-btn" href="${herbData.wiki}" class="wiki-btn" target="_blank">
                        <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹ç™¾åº¦ç™¾ç§‘
                    </a>
                `;

                // æ˜¾ç¤ºç»“æœå¡ç‰‡
                resultCard.classList.add('show');

            } catch (error) {
                console.error('è¯†åˆ«å¤±è´¥:', error);
                statusText.innerHTML = '<i class="fa fa-exclamation-triangle text-red-500 mr-1"></i> è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
            } finally {
                // éšè—åŠ è½½é®ç½©
                loadingMask.style.display = 'none';
                identifyBtn.disabled = false;
            }
        }

        // é‡ç½®åŠŸèƒ½
        function resetAll() {
            // é‡ç½®ç»“æœ
            prediction.textContent = '--';
            confidence.textContent = 'å¯ä¿¡åº¦ï¼š--%';
            wolfberryEl.textContent = '--%';
            chrysanthemumEl.textContent = '--%';
            ginsengEl.textContent = '--%';
            liquoriceEl.textContent = '--%';
            honeysuckleEl.textContent = '--%';
            
            // é‡ç½®æç¤º
            herbTips.innerHTML = `
                <p><i class="fa fa-info-circle mr-1 text-blue-500 dark:text-blue-400"></i> è¯†åˆ«ç»“æœåå°†æ˜¾ç¤ºå¯¹åº”è¯æçš„ç®€è¦ä»‹ç»</p>
                <a id="wiki-btn" href="#" class="wiki-btn hidden" target="_blank">
                    <i class="fa fa-external-link mr-1"></i> æŸ¥çœ‹ç™¾åº¦ç™¾ç§‘
                </a>
            `;
            
            // é‡ç½®é«˜äº®
            probItems.forEach(item => item.classList.remove('highlight'));
            
            // éšè—ç»“æœå¡ç‰‡
            resultCard.classList.remove('show');
            
            // é‡ç½®åª’ä½“åŒºåŸŸ
            webcam.style.display = 'none';
            uploadedImage.style.display = 'none';
            mediaPlaceholder.style.display = 'flex';
            
            // åœæ­¢æ‘„åƒå¤´
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // é‡ç½®æ‘„åƒå¤´æç¤º
            camTip.style.display = 'none';
            camTip.textContent = 'éƒ¨åˆ†æ‰‹æœºéœ€æˆæƒåæ‰èƒ½åˆ‡æ¢æ‘„åƒå¤´';
            
            // ç¦ç”¨è¯†åˆ«æŒ‰é’®
            identifyBtn.disabled = true;
        }

        // äº‹ä»¶ç›‘å¬
        startCamBtn.addEventListener('click', startCamera);
        flipCamBtn.addEventListener('click', flipCamera);
        imageUpload.addEventListener('change', handleImageUpload);
        identifyBtn.addEventListener('click', identifyHerb);
        resetBtn.addEventListener('click', resetAll);

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ¨¡å‹
        window.addEventListener('load', loadModel);

        // æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
